# EKS-Helm ArgoCD

Terraform module which install an ArgoCD to EKS cluster and configure the necessary role and permissions.

## Usage

### Install ArgoCD

```hcl
module "argocd" {
  source = "github.com/spartan-stratos/terraform-modules//aws/eks-helm/argocd?ref=v0.4.3"

  domain_name = "example.com"

  enabled_alb_ingress         = true
  enabled_aws_management_role = true

  applications = {
    "service-platform-dev" = {
      name                     = "service-platform"
      environment              = "dev"
      project_name = "test-eks-dev" #same with cluster name
      destination_cluster_name = "test-eks-dev"
      namespace                = "service-platform"
      repo_url                 = "github.com/...."
    }
  }

  github_app = {
    id          = 123456
    private_key = "key"
  }
  oidc_github_orgs = toset([for org in local.argocd_projects : org.github_organization])
  oidc_github_client_id     = 111111
  oidc_github_client_secret = "secret"
}
```

## Examples

- [Example](./examples/complete)

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                         | Version   |
|------------------------------------------------------------------------------|-----------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform)    | >= 1.10   |
| <a name="requirement_aws"></a> [aws](#requirement\_aws)                      | >= 5.75.0 |
| <a name="requirement_helm"></a> [helm](#requirement\_helm)                   | >=2.16.1  |
| <a name="requirement_kubernetes"></a> [kubernetes](#requirement\_kubernetes) | >= 2.33.0 |

## Providers

| Name                                                                   | Version   |
|------------------------------------------------------------------------|-----------|
| <a name="provider_aws"></a> [aws](#provider\_aws)                      | >= 5.75.0 |
| <a name="provider_helm"></a> [helm](#provider\_helm)                   | >=2.16.1  |
| <a name="provider_kubernetes"></a> [kubernetes](#provider\_kubernetes) | >= 2.33.0 |

## Modules

| Name                                                      | Source        | Version |
|-----------------------------------------------------------|---------------|---------|
| <a name="module_route53"></a> [route53](#module\_route53) | ../../route53 | n/a     |

## Resources

| Name                                                                                                                                                      | Type        |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)                                                 | resource    |
| [aws_iam_role_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy)                                   | resource    |
| [aws_route53_record.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record)                                     | resource    |
| [helm_release.this](https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release)                                                 | resource    |
| [kubernetes_annotations.argocd_application_controller](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/annotations)    | resource    |
| [kubernetes_annotations.argocd_applicationset_controller](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/annotations) | resource    |
| [kubernetes_annotations.argocd_server](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/annotations)                    | resource    |
| [kubernetes_secret.github_app](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/secret)                                 | resource    |
| [kubernetes_secret.repository](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/secret)                                 | resource    |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity)                             | data source |
| [aws_iam_policy_document.allow_assume_remote_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)    | data source |
| [aws_iam_policy_document.assume_role_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)          | data source |

## Inputs

| Name                                                                                                                      | Description                                                                                        | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Default                                  | Required |
|---------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|:--------:|
| <a name="input_alb_cname"></a> [alb\_cname](#input\_alb\_cname)                                                           | Alias for the ALB (required when alb\_zone\_id is not null)                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `null`                                   |    no    |
| <a name="input_alb_zone_id"></a> [alb\_zone\_id](#input\_alb\_zone\_id)                                                   | The Route53 zone ID to create the record in                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `null`                                   |    no    |
| <a name="input_argocd_namespace"></a> [argocd\_namespace](#input\_argocd\_namespace)                                      | Namespace to install Argo CD                                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"argocd"`                               |    no    |
| <a name="input_aws_management_role"></a> [aws\_management\_role](#input\_aws\_management\_role)                           | AWS management role configuration, only required if enabled\_aws\_management\_role is true         | <pre>object({<br/>    eks_oidc_provider_arn = string<br/>    role_name             = string<br/>    eks_oidc_provider_url = string<br/>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `null`                                   |    no    |
| <a name="input_chart_url"></a> [chart\_url](#input\_chart\_url)                                                           | URL of the Argo CD Helm chart                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"https://argoproj.github.io/argo-helm"` |    no    |
| <a name="input_chart_version"></a> [chart\_version](#input\_chart\_version)                                               | Version of the Argo CD Helm chart                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"7.8.26"`                               |    no    |
| <a name="input_create_route53_record"></a> [create\_route53\_record](#input\_create\_route53\_record)                     | Determines whether or not to create a route53 record for the ingress or not                        | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`                                  |    no    |
| <a name="input_domain_name"></a> [domain\_name](#input\_domain\_name)                                                     | Domain name for ArgoCD                                                                             | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a                                      |   yes    |
| <a name="input_enabled_aws_management_role"></a> [enabled\_aws\_management\_role](#input\_enabled\_aws\_management\_role) | Enable the AWS management role for cross cluster management                                        | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`                                  |    no    |
| <a name="input_enabled_managed_in_cluster"></a> [enabled\_managed\_in\_cluster](#input\_enabled\_managed\_in\_cluster)    | Enable in\_cluster manage to rename in\_cluster                                                    | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`                                  |    no    |
| <a name="input_external_clusters"></a> [external\_clusters](#input\_external\_clusters)                                   | Maps of external cluster that want to connect                                                      | <pre>map(object({<br/>    assume_role       = optional(string, "")<br/>    server            = string<br/>    labels            = optional(map(any), {})<br/>    annotations       = optional(map(any), {})<br/>    namespace         = optional(string, "")<br/>    cluster_resources = optional(bool, false)<br/>    config = object({<br/>      aws_auth_config = object({<br/>        cluster_name = string<br/>        role_arn     = string<br/>      })<br/>      tls_client_config = object({<br/>        insecure = optional(bool, false)<br/>        ca_data  = string<br/>      })<br/>    })<br/>  }))</pre> | `{}`                                     |    no    |
| <a name="input_github_app"></a> [github\_app](#input\_github\_app)                                                        | GitHub App configuration to use for Argo CD                                                        | <pre>object({<br/>    secret_name     = string<br/>    app_id          = number<br/>    installation_id = number<br/>    private_key     = string<br/>    organization    = string<br/>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                        | n/a                                      |   yes    |
| <a name="input_handle_tls"></a> [handle\_tls](#input\_handle\_tls)                                                        | If ArgoCD should handle TLS itself                                                                 | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`                                  |    no    |
| <a name="input_in_cluster_name"></a> [in\_cluster\_name](#input\_in\_cluster\_name)                                       | To customize the in\_cluster name for easier management (only `enabled_managed_in_cluster = true`) | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"in_cluster"`                           |    no    |
| <a name="input_ingress_class_name"></a> [ingress\_class\_name](#input\_ingress\_class\_name)                              | Ingress class name for Argo CD                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"alb"`                                  |    no    |
| <a name="input_ingress_group_name"></a> [ingress\_group\_name](#input\_ingress\_group\_name)                              | Ingress group name for Argo CD                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"external"`                             |    no    |
| <a name="input_issuer_url"></a> [issuer\_url](#input\_issuer\_url)                                                        | The issuer URL should be where Dex talks to the OIDC provider                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"http://argocd-dex-server:5556"`        |    no    |
| <a name="input_node_selector"></a> [node\_selector](#input\_node\_selector)                                               | Node selector for the ingress controller                                                           | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `{}`                                     |    no    |
| <a name="input_oidc_github_client_id"></a> [oidc\_github\_client\_id](#input\_oidc\_github\_client\_id)                   | GitHub App Client ID for OIDC                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a                                      |   yes    |
| <a name="input_oidc_github_client_secret"></a> [oidc\_github\_client\_secret](#input\_oidc\_github\_client\_secret)       | GitHub App Client Secret for OIDC                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a                                      |   yes    |
| <a name="input_oidc_github_organization"></a> [oidc\_github\_organization](#input\_oidc\_github\_organization)            | GitHub organization to restrict access to                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a                                      |   yes    |
| <a name="input_rbac_policies"></a> [rbac\_policies](#input\_rbac\_policies)                                               | List of RBAC policies to apply                                                                     | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `[]`                                     |    no    |
| <a name="input_repositories"></a> [repositories](#input\_repositories)                                                    | To connect to repository by using Credentials Template, which is currently using Github App        | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `[]`                                     |    no    |
| <a name="input_server_side_diff"></a> [server\_side\_diff](#input\_server\_side\_diff)                                    | Enable server side diff                                                                            | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `true`                                   |    no    |
| <a name="input_slack_token"></a> [slack\_token](#input\_slack\_token)                                                     | The token to authenticate to slack, which will help application push notification to slack         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `""`                                     |    no    |
| <a name="input_sub_domain"></a> [sub\_domain](#input\_sub\_domain)                                                        | Sub domain for ArgoCD                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"argocd"`                               |    no    |
| <a name="input_tolerations"></a> [tolerations](#input\_tolerations)                                                       | Tolerations for the ingress controller                                                             | <pre>list(object({<br/>    key      = string<br/>    operator = string<br/>    value    = optional(string)<br/>    effect   = optional(string)<br/>  }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `[]`                                     |    no    |

## Outputs

| Name                                                                                       | Description |
|--------------------------------------------------------------------------------------------|-------------|
| <a name="output_aws_iam_role_arn"></a> [aws\_iam\_role\_arn](#output\_aws\_iam\_role\_arn) | n/a         |

<!-- END_TF_DOCS -->
